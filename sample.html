<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Amplify Sample Project</title>
	<link rel="stylesheet" href="./node_modules/amplify-styles/dist/assets/toolkit/styles/amplify-external-styles.css">
    
    <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body>

<h1>Multiselect Component (No Shadow DOM)</h1>

<template id="multiselect-dropdown">

    <div class="amplify-dropdown amplify-multi-select" id="multi-select-menu" role="menu">
        <button class="btn multiselect-btn" type="button" aria-haspopup="true" aria-expanded="false" id="multi-select-button">Select multiple items</button>
        <div class="dropdown-menu" aria-labelledby="multi-select-button">
            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Teacher</span>
            </label>            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Administrator</span>
            </label>            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Principal</span>
            </label>            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Staff</span>
            </label>            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Assistant to the Associate Minister of Directors</span>
            </label>            <label tabindex="0" class="dropdown-item" role="checkbox" aria-checked="false" onfocus="readAriaLabel(event)">
                <input type="checkbox" value="on">
                <div class="checkbox-div"></div>
                <span>Evaluator</span>
            </label>        </div>
    </div>
    <style>
        .drop-demo {
            margin-top: 50px;
        }
        multiselect-dropdown {
            margin-left: 20px;
        }
    </style>
</template>

<div class="drop-demo" style="display:flex;">
    <multiselect-dropdown></multiselect-dropdown>
    <multiselect-dropdown></multiselect-dropdown>
    <multiselect-dropdown></multiselect-dropdown>
</div>

<script>

(function() {
  const doc = (document._currentScript || document.currentScript).ownerDocument;
  const template = doc.querySelector('#multiselect-dropdown');
  const key = {
    tab: 9,
    return: 13,
    escape: 27,
    space: 32,
    up: 38,
    down: 40
  }
  let counter = -1;

  customElements.define('multiselect-dropdown', class extends HTMLElement {

    constructor() {
      super();

        this.addEventListener('click', e => {
            let allmenus = this.getElementsByClassName('amplify-multi-select');
            this.childNodes[1].classList.toggle('show');
        })

        this.addEventListener('keydown', e => {
            const menu = this.children[0];

            if (e.keyCode == key.return || e.keyCode == key.space) {

                if (menu.classList.contains("show")) {
                    e.stopPropagation();
                    e.preventDefault(); 
                    document.activeElement.click();
                    document.activeElement.parentNode.focus();
                    document.activeElement.getAttribute("aria-checked") == "false" ? document.activeElement.setAttribute("aria-checked", "true") : document.activeElement.setAttribute("aria-checked", "false");
                }

            } else if (e.keyCode == key.down) {
                
                e.preventDefault(); 
                counter === -1 ? this.getElementsByClassName('dropdown-item')[0].focus() : '';

            } else if (e.keyCode == key.tab) {

                if (menu.classList.contains("show")) {
                    e.stopPropagation();
                    e.preventDefault(); 
                    menu.classList.remove("show");
                    this.getElementsByClassName('multiselect-btn')[0].focus(); 
                }
            } else if (e.keyCode == key.escape) {
                this.getElementsByClassName('multiselect-btn')[0].focus(); 
            }
        })

        window.addEventListener('click', e => {
            
            let allmenus = this.getElementsByClassName('amplify-multi-select')[0];

            if(!e.target.classList.contains('multiselect-btn') && !e.target.classList.contains('checkbox-div') && !e.target.classList.contains('dropdown-item')  && e.target.nodeName !== "INPUT" && e.target.nodeName !== "SPAN") {
                allmenus.classList.remove('show');
            }

            /*if(e.target.classList.contains('multiselect-btn')) {
                console.log(e.target.parentNode);
                e.target.parentNode.classList.toggle('show');
            }*/
        })
    }

    // Without the shadow DOM, we have to manipulate the custom element
    // after it has been inserted in the DOM.
    connectedCallback() {
      const temp = document.importNode(template.content, true);
      this.appendChild(temp);
    }

  });
})();

</script>


	
    <script src="https://amplifylitco.github.io/styles/assets/toolkit/scripts/toolkit.js"></script>
	<script src="main.js"></script>	
</body>
</html>